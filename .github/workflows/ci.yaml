# This is the main CI pipeline for the project.
name: ğŸ¤– CI Pipeline

# This workflow is triggered on pushes to master/main and on pull requests.
on:
  push:
    branches:
      - master
      - main
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

# Sets default read-only permissions for the workflow.
permissions: read-all

jobs:
  # ============================================
  # Go Operator Build & Test
  # ============================================
  build-go:
    name: ğŸ—ï¸ Build Go Operator
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: locust-k8s-operator-go
    steps:
      - name: ğŸ“‚ Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: locust-k8s-operator-go/go.mod

      - name: ğŸ“¥ Download dependencies
        run: go mod download

      - name: ğŸ” Run linter
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.1.0
          working-directory: locust-k8s-operator-go

      - name: ğŸ› ï¸ Build
        run: make build

      - name: âœ… Run tests
        run: make test

      - name: ğŸ“Š Report coverage
        if: always()
        uses: codecov/codecov-action@v5
        with:
          files: locust-k8s-operator-go/cover.out
          flags: go-unit-tests
          name: go-coverage
          fail_ci_if_error: false

  # ============================================
  # Helm Chart Lint & Test
  # ============================================
  lint-test-helm:
    name: ğŸŒŠ Lint & Test chart
    runs-on: ubuntu-latest
    needs:
      - build-go
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: ğŸŒŠ Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          check-latest: true

      - name: ğŸ“Š Set up chart-testing
        uses: helm/chart-testing-action@v2.7.0

      - name: ğŸ“‹ Run chart-testing (list-changed)
        id: list-changed
        run: |
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Run chart-testing (lint)
        run: ct lint --target-branch ${{ github.event.repository.default_branch }} --config .github/ct.yaml

      - name: â›µ Create kind cluster
        uses: helm/kind-action@v1.12.0
        if: steps.list-changed.outputs.changed == 'true'

      - name: ğŸ”§ Setup Go
        if: steps.list-changed.outputs.changed == 'true'
        uses: actions/setup-go@v5
        with:
          go-version-file: locust-k8s-operator-go/go.mod

      - name: ğŸ› ï¸ Install ko
        if: steps.list-changed.outputs.changed == 'true'
        uses: ko-build/setup-ko@v0.7

      - name: ğŸ³ Build operator image with ko
        if: steps.list-changed.outputs.changed == 'true'
        working-directory: locust-k8s-operator-go
        env:
          KO_DOCKER_REPO: lotest/locust-k8s-operator
        run: |
          CHART_VERSION=$(grep '^appVersion:' ../charts/locust-k8s-operator/Chart.yaml | awk '{print $2}' | tr -d '"')
          ko build ./cmd/main.go --local --bare --tags=${CHART_VERSION}

      - name: ğŸ“¦ Load image into kind cluster
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          CHART_VERSION=$(grep '^appVersion:' charts/locust-k8s-operator/Chart.yaml | awk '{print $2}' | tr -d '"')
          kind load docker-image lotest/locust-k8s-operator:${CHART_VERSION}

      - name: ğŸš€ Run chart-testing (install)
        run: ct install --target-branch ${{ github.event.repository.default_branch }} --config .github/ct.yaml --helm-extra-set-args "--set=image.pullPolicy=Never"

  docs-test:
    name: ğŸ“š Test documentation
    runs-on: ubuntu-latest
    needs:
      - lint-test-helm
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: ğŸ Setup python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install \
          mkdocs-material \
          mkdocs-git-revision-date-localized-plugin

      - name: ğŸ“„ Build documentation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m mkdocs build
