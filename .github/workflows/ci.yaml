# This is the main CI pipeline for the project.
name: ğŸ¤– CI Pipeline

# This workflow is triggered on pushes to master/main and on pull requests.
on:
  push:
    branches:
      - master
      - main
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

# Sets default read-only permissions for the workflow.
permissions:
  contents: read
  security-events: write # Required for uploading SARIF to GitHub Security tab

jobs:
  # ============================================
  # Go Operator Build & Test
  # ============================================
  build-go:
    name: ğŸ—ï¸ Build Go Operator
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ğŸ“‚ Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: ğŸ“¥ Download dependencies
        run: go mod download

      - name: ğŸ” Run linter
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest # Use latest to support Go 1.25

      - name: ğŸ› ï¸ Build
        run: make build

      - name: âœ… Run tests
        run: make test

      - name: ğŸ“Š Report coverage
        if: always()
        uses: codecov/codecov-action@v5
        with:
          files: cover.out
          flags: go-unit-tests
          name: go-coverage
          fail_ci_if_error: false

      - name: ğŸ“ˆ Report coverage to Codacy
        if: always()
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: cover.out
          force-coverage-parser: go

      - name: ğŸ“¦ Upload Go test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: go-test-artifacts
          path: |
            cover.out
          retention-days: 7

  # ============================================
  # Helm Chart Lint & Test
  # ============================================
  lint-test-helm:
    name: ğŸŒŠ Lint & Test chart
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: ğŸŒŠ Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          check-latest: true

      - name: ğŸ“Š Set up chart-testing
        uses: helm/chart-testing-action@v2.7.0

      - name: ğŸ“‹ Run chart-testing (list-changed)
        id: list-changed
        run: |
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Run chart-testing (lint)
        run: ct lint --target-branch ${{ github.event.repository.default_branch }} --config .github/ct.yaml

      - name: â›µ Create kind cluster
        uses: helm/kind-action@v1.12.0
        if: steps.list-changed.outputs.changed == 'true'

      - name: ğŸ”§ Setup Go
        if: steps.list-changed.outputs.changed == 'true'
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: ğŸ› ï¸ Install ko
        if: steps.list-changed.outputs.changed == 'true'
        uses: ko-build/setup-ko@v0.7

      - name: ğŸ³ Build operator image with ko
        if: steps.list-changed.outputs.changed == 'true'
        env:
          KO_DOCKER_REPO: lotest/locust-k8s-operator
        run: |
          CHART_VERSION=$(grep '^appVersion:' charts/locust-k8s-operator/Chart.yaml | awk '{print $2}' | tr -d '"')
          ko build ./cmd --local --bare --tags=${CHART_VERSION}

      - name: ğŸ“¦ Load image into kind cluster
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          CHART_VERSION=$(grep '^appVersion:' charts/locust-k8s-operator/Chart.yaml | awk '{print $2}' | tr -d '"')
          kind load docker-image lotest/locust-k8s-operator:${CHART_VERSION} --name chart-testing

      - name: ğŸš€ Run chart-testing (install)
        run: ct install --target-branch ${{ github.event.repository.default_branch }} --config .github/ct.yaml --helm-extra-set-args "--set=image.pullPolicy=Never"

      - name: ğŸ“¦ Collect kind cluster logs on failure
        if: failure() && steps.list-changed.outputs.changed == 'true'
        run: kind export logs kind-logs --name chart-testing

      - name: ğŸ“¦ Upload Helm test artifacts on failure
        if: failure() && steps.list-changed.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: helm-test-artifacts
          path: |
            kind-logs/
          retention-days: 7

  docs-test:
    name: ğŸ“š Test documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: ğŸ Setup python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install \
          mkdocs-material \
          mkdocs-git-revision-date-localized-plugin \
          mkdocs-minify-plugin

      - name: ğŸ“„ Build documentation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m mkdocs build

      - name: ğŸ“¦ Upload docs build artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docs-build-artifacts
          path: |
            site/
          retention-days: 7

  # ============================================
  # Security Scanning with Trivy
  # ============================================
  security-scan:
    name: ğŸ”’ Security scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: ğŸ› ï¸ Install ko
        uses: ko-build/setup-ko@v0.7

      - name: ğŸ³ Build operator image with ko
        env:
          KO_DOCKER_REPO: lotest/locust-k8s-operator
        run: |
          CHART_VERSION=$(grep '^appVersion:' charts/locust-k8s-operator/Chart.yaml | awk '{print $2}' | tr -d '"')
          ko build ./cmd --local --bare --tags=${CHART_VERSION}
          echo "IMAGE_TAG=${CHART_VERSION}" >> $GITHUB_ENV

      - name: ğŸ” Run Trivy security scan
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: lotest/locust-k8s-operator:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          exit-code: 1 # Fail the build if vulnerabilities are found

      - name: ğŸ“Š Upload Trivy results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
          category: trivy-container-scan

      - name: ğŸ“¦ Upload Trivy scan artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results
          path: trivy-results.sarif
          retention-days: 7
