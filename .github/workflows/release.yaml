# This workflow publishes the Docker image and Helm chart when a new tag is pushed.
name: ğŸš€ Publish image & helm

# Triggered on a push event for any tag.
on:
  push:
    tags:
      - "*"

jobs:
  # ============================================
  # Go Operator Docker Image
  # ============================================
  publish-image:
    name: ğŸ³ Publish image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    env:
      DOCKER_IMAGE: lotest/locust-k8s-operator
    steps:
      - name: ğŸ“‚ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: ğŸ”§ Setup ko
        uses: ko-build/setup-ko@v0.7

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ“¦ Build and push with ko
        env:
          KO_DOCKER_REPO: ${{ env.DOCKER_IMAGE }}
        run: |
          ko build ./cmd \
            --platform=linux/amd64,linux/arm64 \
            --bare \
            --tags=${{ github.ref_name }},latest,${{ github.sha }}

  helm-chart-release:
    name: ğŸŒŠ Publish Helm chart
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [publish-image]
    permissions:
      contents: write
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âœï¸ Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: ğŸŒŠ Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: ğŸ“¦ Custom packaging
        run: |
          VERSION=${{github.ref_name}}
          rm -rf .cr-release-packages
          mkdir -p .cr-release-packages
          helm package charts/locust-k8s-operator --app-version=${VERSION} --version=${VERSION} --destination=.cr-release-packages

      # Pin to v1.6.1 to avoid latest_tag scope bug in v1.7.0+
      # See: https://github.com/helm/chart-releaser-action/issues/171
      - name: ğŸ‰ Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.1
        with:
          skip_packaging: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

  docs-release:
    name: ğŸ“š Publish documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install \
          mkdocs-material \
          mkdocs-git-revision-date-localized-plugin \
          mkdocs-minify-plugin

      - name: ğŸš€ Build documentation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m mkdocs build

      - name: ğŸš€ Deploy documentation
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          keep_files: true
          user_name: ${{ github.actor }}
          user_email: ${{ github.actor }}@users.noreply.github.com
