{{/*
=============================================================================
RBAC CONFIGURATION FOR LOCUST K8S OPERATOR
=============================================================================
This template creates the ServiceAccount and RBAC rules needed by the operator.

The operator needs permissions to:
  1. Manage LocustTest CRs (create, update, delete, watch)
  2. Update status subresource (report test status back to CR)
  3. Manage finalizers (cleanup resources when CR is deleted)
  4. Create/manage Jobs (master and worker pods)
  5. Create/manage Services (master service for worker communication)
  6. Create/manage ConfigMaps (test files, library files)
  7. Read Secrets (for env injection, Kafka credentials)
  8. Create Events (for status reporting)
  9. Manage Leases (for leader election in HA mode)

ClusterRole vs Role:
  - ClusterRole (k8s.clusterRole.enabled=true): Operator can manage tests in ALL namespaces
  - Role (k8s.clusterRole.enabled=false): Operator limited to its own namespace
=============================================================================
*/}}

{{- if .Values.serviceAccount.create -}}
{{- $serviceAccountName := include "locust-k8s-operator.serviceAccountName" . }}
{{- $namespace := .Release.Namespace }}

# =============================================================================
# ServiceAccount - Identity for the operator pod
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $serviceAccountName }}
  namespace: {{ $namespace }}
  labels:
    {{- include "locust-k8s-operator.labels" . | nindent 4 }}
  {{- with .Values.serviceAccount.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
{{- if .Values.image.pullSecrets }}
imagePullSecrets:
{{- range .Values.image.pullSecrets }}
  - name: {{ . }}
{{- end }}
{{- end }}
---

# =============================================================================
# ClusterRole/Role - Permissions for the operator
# =============================================================================
# Use ClusterRole for multi-namespace operation, Role for single namespace
{{- if .Values.k8s.clusterRole.enabled }}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
{{- else }}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
{{- end }}
metadata:
  name: {{ $serviceAccountName }}
  labels:
    {{- include "locust-k8s-operator.labels" . | nindent 4 }}
  {{- if not .Values.k8s.clusterRole.enabled }}
  namespace: {{ $namespace }}
  {{- end }}
rules:
  # -----------------------------------------------------------------------
  # LocustTest Custom Resource permissions
  # -----------------------------------------------------------------------
  # Main CR - operator watches these and reconciles state
  - apiGroups: ["locust.io"]
    resources: ["locusttests"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Status subresource - operator reports test status here
  - apiGroups: ["locust.io"]
    resources: ["locusttests/status"]
    verbs: ["get", "update", "patch"]
  # Finalizers - ensure cleanup happens before CR deletion
  - apiGroups: ["locust.io"]
    resources: ["locusttests/finalizers"]
    verbs: ["update"]

  # -----------------------------------------------------------------------
  # Core Kubernetes resources
  # -----------------------------------------------------------------------
  # ConfigMaps - store test files and library code
  # Secrets - read credentials for env injection
  # Services - expose master pod to workers
  - apiGroups: [""]
    resources: ["configmaps", "secrets", "services"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Events - report status changes and errors
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

  # -----------------------------------------------------------------------
  # Batch resources
  # -----------------------------------------------------------------------
  # Jobs - master and worker pods run as Jobs
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # -----------------------------------------------------------------------
  # Coordination resources
  # -----------------------------------------------------------------------
  # Leases - used for leader election in HA deployments
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---

# =============================================================================
# ClusterRoleBinding/RoleBinding - Bind permissions to ServiceAccount
# =============================================================================
{{- if .Values.k8s.clusterRole.enabled }}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
{{- else }}
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
{{- end }}
metadata:
  name: {{ $serviceAccountName }}
  labels:
    {{- include "locust-k8s-operator.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: {{ if .Values.k8s.clusterRole.enabled }}ClusterRole{{ else }}Role{{ end }}
  name: {{ $serviceAccountName }}
subjects:
  - kind: ServiceAccount
    name: {{ $serviceAccountName }}
    namespace: {{ $namespace }}
{{- end }}
