# Phase 7: v2 API Types (New Features)

**Status:** ✅ Complete  
**Effort:** 1.5 days  
**Priority:** P1 - Must Have  
**Dependencies:** Phase 4 (Core Reconciler)

---

## Overview

Define the v2 API with grouped configuration and new feature fields. This phase introduces the enhanced `LocustTest` CRD structure that enables new features like separate master/worker resources, environment injection, volume mounting, and OpenTelemetry support.

## Documents

| Document | Purpose |
|----------|---------|
| [IMPLEMENTATION.md](./IMPLEMENTATION.md) | Detailed step-by-step implementation guide |
| [CHECKLIST.md](./CHECKLIST.md) | Quick reference task checklist |

## Current State

Phase 4-6 delivered a working Go operator with v1 API parity:
- v1 API types in `api/v1/locusttest_types.go`
- Working reconciler that creates Jobs and Services
- Full test coverage (unit + integration)

**Phase 7 Goal:** Create v2 API as the storage version with grouped specs and new features.

## Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Storage Version** | v2 | New features require v2 as storage version |
| **Hub Version** | v2 | v2 is the canonical representation for conversions |
| **Grouped Specs** | `master`, `worker`, `testFiles`, `scheduling` | Better UX, aligns with user mental model |
| **Status Subresource** | Phase + Conditions | Standard K8s pattern for state tracking |
| **Feature Scoping** | Types only, no logic | Implementation deferred to Phases 9-12 |

## v2 API Structure

### Grouped Configuration

```yaml
apiVersion: locust.io/v2
kind: LocustTest
spec:
  image: "locustio/locust:2.43.1"
  
  master:                    # Grouped master config
    command: "locust -f /lotest/src/locustfile.py"
    resources: {...}
    labels: {...}
    annotations: {...}
    autostart: true
    autoquit: {enabled: true, timeout: 60}
    extraArgs: []
  
  worker:                    # Grouped worker config
    command: "locust -f /lotest/src/locustfile.py"
    replicas: 10
    resources: {...}
    labels: {...}
    annotations: {...}
    extraArgs: []
  
  testFiles:                 # Renamed for clarity
    configMapRef: "my-tests"
    libConfigMapRef: "my-lib"
  
  scheduling:                # Grouped scheduling
    affinity: {...}
    tolerations: [...]
    nodeSelector: {...}
  
  env:                       # NEW: Environment injection
    configMapRefs: [...]
    secretRefs: [...]
    variables: [...]
    secretMounts: [...]
  
  volumes: [...]             # NEW: Volume definitions
  volumeMounts: [...]        # NEW: Volume mounts with target
  
  observability:             # NEW: OpenTelemetry config
    openTelemetry:
      enabled: true
      endpoint: "..."
```

### New Feature Types

| Type | Purpose | Related Issue |
|------|---------|---------------|
| `MasterSpec` | Grouped master configuration | #245, #246 |
| `WorkerSpec` | Grouped worker configuration | #245, #246 |
| `TestFilesConfig` | Renamed configMap fields | Clarity |
| `SchedulingConfig` | Grouped scheduling config | Cleanup |
| `EnvConfig` | Secret/ConfigMap injection | #149 |
| `VolumeMount` | Volume mounting with target | #252 |
| `ObservabilityConfig` | OpenTelemetry settings | #72 |
| `LocustTestStatus` | Phase and conditions | #5.1.4 |

## Files to Create

| File | Purpose |
|------|---------|
| `api/v2/groupversion_info.go` | v2 group/version registration |
| `api/v2/locusttest_types.go` | All v2 type definitions |
| `api/v2/conditions.go` | Condition type and reason constants |
| `api/v2/zz_generated.deepcopy.go` | Auto-generated by controller-gen |

## Acceptance Criteria

1. **v2 CRD Generated:**
   - `make manifests` generates v2 CRD in `config/crd/bases/`
   - CRD includes all new fields with proper validation markers

2. **Storage Version:**
   - v2 marked with `+kubebuilder:storageversion`
   - v1 remains for backward compatibility (conversion in Phase 8)

3. **Type Validation:**
   - Sample v2 CR validates against schema
   - `make generate` produces `zz_generated.deepcopy.go`

4. **Printer Columns:**
   - `kubectl get locusttests` shows Phase, Workers, Connected, Age

## Non-Goals (Deferred to Later Phases)

| Feature | Phase |
|---------|-------|
| v1↔v2 Conversion Logic | Phase 8 |
| Status Update Logic | Phase 9 |
| Environment Injection Logic | Phase 10 |
| Volume Mounting Logic | Phase 11 |
| OpenTelemetry Logic | Phase 12 |

## Commands

```bash
# Create v2 API scaffold
operator-sdk create api \
  --group locust \
  --version v2 \
  --kind LocustTest \
  --resource \
  --controller=false

# Generate DeepCopy methods
make generate

# Generate CRD manifests
make manifests

# Verify CRD
cat config/crd/bases/locust.io_locusttests.yaml

# Validate sample CR against CRD
kubectl apply --dry-run=client -f config/samples/locust_v2_locusttest.yaml
```

## References

- [ROADMAP.md](../../ROADMAP.md) - Phase 7 definition (lines 365-410)
- [REQUIREMENTS.md](../../REQUIREMENTS.md) - §4.2 LocustTest v2 Spec, §5.1 Must Have Features
- [CRD_API_DESIGN.md](../../research/CRD_API_DESIGN.md) - Complete v2 type definitions
- [Kubebuilder Markers](https://book.kubebuilder.io/reference/markers.html)
- [API Conventions](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md)
