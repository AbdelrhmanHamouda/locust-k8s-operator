# Locust K8s Operator - Project Analysis for Go Migration

**Analysis Date:** January 2026  
**Project Version:** 1.1.1  
**Purpose:** Detailed technical analysis of stack, architecture, conventions, and migration concerns

---

## Table of Contents

1. [Technology Stack Analysis](#1-technology-stack-analysis)
2. [Architecture Deep Dive](#2-architecture-deep-dive)
3. [Code Conventions & Patterns](#3-code-conventions--patterns)
4. [Migration Concerns & Risk Assessment](#4-migration-concerns--risk-assessment)
5. [Component-by-Component Migration Guide](#5-component-by-component-migration-guide)
6. [File Inventory](#6-file-inventory)

---

## 1. Technology Stack Analysis

### 1.1 Runtime & Language

| Component | Current | Go Equivalent | Migration Notes |
|-----------|---------|---------------|-----------------|
| **Language** | Java 21 (LTS) | Go 1.21+ | Major paradigm shift (OOP → struct-based) |
| **Build Tool** | Gradle 8.x | `go build` / Go modules | Significantly simpler |
| **Container Build** | Jib 3.3.2 | `ko` or Dockerfile | Smaller images (~10-20MB vs ~200MB) |
| **Package Manager** | Maven Central | Go modules | Faster dependency resolution |

### 1.2 Framework Stack

| Framework | Version | Purpose | Go Equivalent |
|-----------|---------|---------|---------------|
| **Micronaut** | 4.5.4 | Application framework, DI, config | Not needed (stdlib + wire optional) |
| **Java Operator SDK** | 5.1.1 | K8s operator framework | Operator SDK |
| **Fabric8 K8s Client** | 7.3.1 | Kubernetes API client | `client-go` / controller-runtime |
| **Lombok** | Latest | Boilerplate reduction | Not needed (Go simplicity) |
| **Logback** | 1.2.11 | Logging | `slog` (stdlib) or `zap` |
| **Micrometer** | 4.2.1 | Metrics (Prometheus) | `prometheus/client_golang` |

### 1.3 Testing Stack

| Library | Version | Purpose | Go Equivalent |
|---------|---------|---------|---------------|
| **JUnit 5** | Latest | Unit testing | `testing` (stdlib) |
| **Mockito** | 4.8.0 | Mocking | `gomock` or `testify/mock` |
| **AssertJ** | 3.23.1 | Fluent assertions | `testify/assert` |
| **Fabric8 Mock Server** | 7.3.1 | K8s API mocking | `envtest` (controller-runtime) |
| **System Lambda** | 1.2.1 | Env var testing | `t.Setenv()` (stdlib Go 1.17+) |

### 1.4 Infrastructure Stack

| Component | Current | Migration Impact |
|-----------|---------|------------------|
| **Helm Chart** | v1.1.1 | Minimal changes (update image, remove JVM configs) |
| **CRD** | OpenAPI v3 schema | Regenerate from Go types (kubebuilder markers) |
| **Docker Image** | ~200MB (JVM) | ~15-25MB (Go static binary) |
| **RBAC** | Helm-managed | Can be auto-generated by kubebuilder |

---

## 2. Architecture Deep Dive

### 2.1 Package Structure

```
src/main/java/com/locust/
├── Application.java              # Entry point (Micronaut bootstrap)
├── LocustTestOperatorStarter.java # Operator lifecycle management
└── operator/
    ├── controller/
    │   ├── LocustTestReconciler.java      # Core reconciliation logic
    │   ├── config/
    │   │   └── SysConfig.java             # Configuration binding
    │   ├── dto/
    │   │   ├── LoadGenerationNode.java    # Internal domain model
    │   │   ├── MetricsExporterContainer.java
    │   │   ├── OperationalMode.java       # Enum: MASTER/WORKER
    │   │   └── OperatorType.java          # Enum: EQUAL/EXISTS
    │   └── utils/
    │       ├── Constants.java             # Static constants
    │       ├── LoadGenHelpers.java        # Business logic helpers
    │       └── resource/
    │           └── manage/
    │               ├── ResourceCreationManager.java   # K8s resource creation
    │               ├── ResourceCreationHelpers.java   # Resource builders
    │               └── ResourceDeletionManager.java   # K8s resource deletion
    └── customresource/
        ├── LocustTest.java                # CRD type definition
        ├── LocustTestSpec.java            # Spec fields
        └── internaldto/
            ├── LocustTestAffinity.java    # Affinity sub-structure
            ├── LocustTestNodeAffinity.java
            └── LocustTestToleration.java  # Toleration sub-structure
```

### 2.2 Go Target Structure

```
/
├── cmd/
│   └── manager/
│       └── main.go                        # Entry point
├── api/
│   └── v1/
│       ├── locusttest_types.go            # CRD types
│       ├── locusttest_types_test.go
│       └── zz_generated.deepcopy.go       # Auto-generated
├── internal/
│   ├── controller/
│   │   ├── locusttest_controller.go       # Reconciler
│   │   └── locusttest_controller_test.go
│   ├── resources/
│   │   ├── job.go                         # Job builder
│   │   ├── service.go                     # Service builder
│   │   └── helpers.go                     # Shared utilities
│   └── config/
│       └── config.go                      # Operator configuration
├── config/
│   ├── crd/
│   │   └── bases/                         # Generated CRDs
│   ├── rbac/
│   └── manager/
└── test/
    └── e2e/                               # End-to-end tests
```

### 2.3 Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Kubernetes API Server                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  LocustTest CR (locust.io/v1)                             │   │
│  │  ├── .metadata.name: "team-a.load-test-1"                │   │
│  │  ├── .spec.masterCommandSeed: "locust -f /lotest/..."    │   │
│  │  ├── .spec.workerCommandSeed: "locust -f /lotest/..."    │   │
│  │  ├── .spec.workerReplicas: 10                            │   │
│  │  └── .spec.image: "my-registry/locust:latest"            │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │ Watch
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    LocustTestReconciler                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  reconcile(resource, context)                             │   │
│  │    if generation > 1 → NO-OP (updates ignored)           │   │
│  │    else:                                                  │   │
│  │      1. generateLoadGenNodeObject(resource, MASTER)      │   │
│  │      2. generateLoadGenNodeObject(resource, WORKER)      │   │
│  │      3. createMasterService(masterNode, namespace)       │   │
│  │      4. createJob(masterNode, namespace, testName)       │   │
│  │      5. createJob(workerNode, namespace, testName)       │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  cleanup(resource, context)                               │   │
│  │      1. deleteService(resource, MASTER)                  │   │
│  │      2. deleteJob(resource, MASTER)                      │   │
│  │      3. deleteJob(resource, WORKER)                      │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │ Creates/Deletes
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Managed Resources                             │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │   Service      │  │   Master Job   │  │   Worker Job   │    │
│  │   (ClusterIP)  │  │   (parallel=1) │  │   (parallel=N) │    │
│  │   ports:       │  │   ┌─────────┐  │  │   ┌─────────┐  │    │
│  │   - 5557       │  │   │ locust  │  │  │   │ locust  │  │    │
│  │   - 5558       │  │   │ master  │  │  │   │ worker  │  │    │
│  │   - 9646       │  │   ├─────────┤  │  │   └─────────┘  │    │
│  │                │  │   │ metrics │  │  │                │    │
│  │                │  │   │exporter │  │  │                │    │
│  │                │  │   └─────────┘  │  │                │    │
│  └────────────────┘  └────────────────┘  └────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 Key Design Decisions

| Decision | Rationale | Go Migration Impact |
|----------|-----------|---------------------|
| **Immutable CRs** | Updates are NO-OP; delete and recreate for changes | Trivial to implement |
| **Jobs over Deployments** | Tests are one-shot; TTL cleanup built-in | Same pattern applies |
| **No Status Subresource** | Fire-and-forget; rely on Job/Pod status | Consider adding status for observability |
| **Metrics Sidecar** | Prometheus exporter runs alongside master | Same pattern, container spec |
| **Kafka Env Vars** | Optional Kafka integration via environment | Same approach via ConfigMap/Secret |

---

## 3. Code Conventions & Patterns

### 3.1 Naming Conventions

| Java Convention | Example | Go Convention |
|-----------------|---------|---------------|
| camelCase fields | `workerReplicas` | Same (exported: `WorkerReplicas`) |
| PascalCase classes | `LocustTestSpec` | Same for types |
| ALL_CAPS constants | `MASTER_NODE_PORTS` | Package-level vars or const blocks |
| get/set prefixes | `getWorkerReplicas()` | Direct field access |
| `*Manager` suffix | `ResourceCreationManager` | `*Builder` or `*Reconciler` |
| `*Helpers` suffix | `LoadGenHelpers` | Functions in same package |

### 3.2 Java Patterns → Go Equivalents

#### 3.2.1 Builder Pattern (Fabric8)

**Java:**
```java
Job job = new JobBuilder()
    .withMetadata(new ObjectMetaBuilder().withName(name).build())
    .withSpec(new JobSpecBuilder()
        .withParallelism(replicas)
        .withBackoffLimit(0)
        .build())
    .build();
```

**Go (client-go):**
```go
job := &batchv1.Job{
    ObjectMeta: metav1.ObjectMeta{Name: name},
    Spec: batchv1.JobSpec{
        Parallelism:  ptr.To(int32(replicas)),
        BackoffLimit: ptr.To(int32(0)),
    },
}
```

#### 3.2.2 Dependency Injection

**Java (Micronaut):**
```java
@Singleton
public class LocustTestReconciler {
    private final LoadGenHelpers loadGenHelpers;
    
    public LocustTestReconciler(LoadGenHelpers loadGenHelpers) {
        this.loadGenHelpers = loadGenHelpers;
    }
}
```

**Go (explicit wiring):**
```go
type LocustTestReconciler struct {
    Client   client.Client
    Scheme   *runtime.Scheme
    Config   *Config
    Recorder record.EventRecorder
}

// Setup in main.go
func main() {
    reconciler := &controller.LocustTestReconciler{
        Client: mgr.GetClient(),
        Scheme: mgr.GetScheme(),
        Config: loadConfig(),
    }
}
```

#### 3.2.3 Configuration Binding

**Java (Micronaut @Property):**
```java
@Property(name = "config.load-generation-pods.resource.cpu-request")
private String podCpuRequest;
```

**Go (env + struct tags):**
```go
type Config struct {
    PodCPURequest string `env:"POD_CPU_REQUEST" envDefault:"250m"`
    PodMemRequest string `env:"POD_MEM_REQUEST" envDefault:"128Mi"`
}

// Using github.com/caarlos0/env/v10
func LoadConfig() (*Config, error) {
    cfg := &Config{}
    return cfg, env.Parse(cfg)
}
```

#### 3.2.4 Enum Pattern

**Java:**
```java
public enum OperationalMode {
    MASTER("master"),
    WORKER("worker");
    
    @Getter
    private final String mode;
}
```

**Go:**
```go
type OperationalMode string

const (
    Master OperationalMode = "master"
    Worker OperationalMode = "worker"
)
```

### 3.3 Error Handling

**Java (try-catch with logging):**
```java
try (KubernetesClient client = new KubernetesClientBuilder().build()) {
    Job job = client.batch().v1().jobs()
        .inNamespace(namespace)
        .resource(job)
        .serverSideApply();
} catch (Exception e) {
    log.error("Exception occurred: {}", e.getLocalizedMessage(), e);
}
```

**Go (explicit error returns):**
```go
if err := r.Create(ctx, job); err != nil {
    if !errors.IsAlreadyExists(err) {
        log.Error(err, "Failed to create Job", "job", job.Name)
        return ctrl.Result{}, err
    }
}
```

### 3.4 Logging Conventions

| Java (Slf4j) | Go (slog/zap) |
|--------------|---------------|
| `log.info("Message: {}", var)` | `log.Info("Message", "key", var)` |
| `log.debug("Details: {}", obj)` | `log.V(1).Info("Details", "obj", obj)` |
| `log.error("Error: {}", e, e)` | `log.Error(err, "Error occurred")` |

---

## 4. Migration Concerns & Risk Assessment

### 4.1 High Priority Concerns

#### 4.1.1 Kubernetes Client Differences

| Concern | Risk | Mitigation |
|---------|------|------------|
| **Builder API differences** | Medium | Use struct literals; more verbose but idiomatic |
| **Server-side apply** | Low | Fully supported in client-go |
| **Resource watching** | Low | controller-runtime handles this |
| **Client lifecycle** | Low | Managed by controller-runtime |

**Current Java Pattern:**
```java
// Creates new client per operation
try (KubernetesClient client = new KubernetesClientBuilder().build()) {
    client.batch().v1().jobs().inNamespace(ns).resource(job).serverSideApply();
}
```

**Go Pattern (shared client):**
```go
// Client injected by controller-runtime, reused
func (r *Reconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
    if err := r.Client.Create(ctx, job); err != nil { ... }
}
```

#### 4.1.2 Configuration Management

| Concern | Risk | Mitigation |
|---------|------|------------|
| **Micronaut property binding** | Medium | Use `viper` for similar functionality |
| **Nested config structure** | Low | Flatten or use struct embedding |
| **Default values** | Low | Struct tags with defaults |

**Key Config Properties to Migrate:**

```yaml
config:
  load-generation-jobs:
    ttl-seconds-after-finished: ${JOB_TTL_SECONDS_AFTER_FINISHED:}
  load-generation-pods:
    resource:
      cpu-request: ${POD_CPU_REQUEST:`250m`}
      mem-request: ${POD_MEM_REQUEST:`128Mi`}
    metricsExporter:
      image: ${METRICS_EXPORTER_IMAGE:`containersol/locust_exporter:v0.5.0`}
      port: ${METRICS_EXPORTER_PORT:`9646`}
    affinity:
      enableCrInjection: ${ENABLE_AFFINITY_CR_INJECTION:false}
```

### 4.2 Medium Priority Concerns

#### 4.2.1 Test Migration

| Test Type | Current Approach | Go Approach |
|-----------|------------------|-------------|
| **Unit tests** | JUnit 5 + Mockito | `testing` + `testify` |
| **K8s API mocks** | Fabric8 MockServer | `envtest` (controller-runtime) |
| **Integration tests** | K3s + Testcontainers | `envtest` or Kind + `controller-runtime` |
| **Assertions** | AssertJ fluent | `testify/assert` |

**Test File Mapping:**

| Java Test | Go Equivalent |
|-----------|---------------|
| `LocustTestReconcilerTests.java` | `locusttest_controller_test.go` |
| `LoadGenHelpersTest.java` | `helpers_test.go` |
| `ResourceCreationHelpersTest.java` | `job_test.go`, `service_test.go` |
| `TestFixtures.java` | `testdata/` + fixture functions |

#### 4.2.2 Helm Chart Updates

**Required Changes:**

```yaml
# values.yaml changes
image:
  repository: lotest/locust-k8s-operator  # Same
  tag: "2.0.0-go"                          # New tag scheme

# Remove JVM-specific configs
# resources:
#   limits:
#     memory: 512Mi  # Was needed for JVM
# Add:
resources:
  limits:
    memory: 64Mi    # Go binary needs much less

# Remove environment variables:
# - JAVA_OPTS
# - MICRONAUT_* 

# Keep application configs (same env var names)
```

### 4.3 Low Priority Concerns

| Concern | Risk | Notes |
|---------|------|-------|
| **Kafka env vars** | Low | Pass-through; no Java-specific logic |
| **Prometheus annotations** | Low | Same annotations on pods |
| **RBAC rules** | Low | Auto-generated by kubebuilder |
| **CRD schema** | Low | Regenerated from Go types |

---

## 5. Component-by-Component Migration Guide

### 5.1 Phase 1: Core Types & CRD

**Source Files:**
- `LocustTest.java` → `api/v1/locusttest_types.go`
- `LocustTestSpec.java` → `api/v1/locusttest_types.go`
- `LocustTestAffinity.java` → `api/v1/locusttest_types.go`
- `LocustTestToleration.java` → `api/v1/locusttest_types.go`

**Go Type Definition:**
```go
// api/v1/locusttest_types.go

// LocustTestSpec defines the desired state of LocustTest
type LocustTestSpec struct {
    // +kubebuilder:validation:Required
    MasterCommandSeed string `json:"masterCommandSeed"`
    
    // +kubebuilder:validation:Required
    WorkerCommandSeed string `json:"workerCommandSeed"`
    
    // +kubebuilder:validation:Required
    // +kubebuilder:validation:Minimum=1
    // +kubebuilder:validation:Maximum=500
    WorkerReplicas int32 `json:"workerReplicas"`
    
    // +kubebuilder:validation:Required
    Image string `json:"image"`
    
    // +optional
    ConfigMap string `json:"configMap,omitempty"`
    
    // +optional
    LibConfigMap string `json:"libConfigMap,omitempty"`
    
    // +optional
    Labels *PodLabels `json:"labels,omitempty"`
    
    // +optional
    Annotations *PodAnnotations `json:"annotations,omitempty"`
    
    // +optional
    Affinity *LocustTestAffinity `json:"affinity,omitempty"`
    
    // +optional
    Tolerations []LocustTestToleration `json:"tolerations,omitempty"`
    
    // +optional
    // +kubebuilder:validation:Enum=Always;IfNotPresent;Never
    ImagePullPolicy corev1.PullPolicy `json:"imagePullPolicy,omitempty"`
    
    // +optional
    ImagePullSecrets []string `json:"imagePullSecrets,omitempty"`
}

type PodLabels struct {
    Master map[string]string `json:"master,omitempty"`
    Worker map[string]string `json:"worker,omitempty"`
}

type PodAnnotations struct {
    Master map[string]string `json:"master,omitempty"`
    Worker map[string]string `json:"worker,omitempty"`
}
```

### 5.2 Phase 2: Configuration

**Source Files:**
- `SysConfig.java` → `internal/config/config.go`
- `application.yml` → Environment variables / ConfigMap

**Effort:** ~50 LOC

### 5.3 Phase 3: Resource Builders

**Source Files:**
- `ResourceCreationHelpers.java` (588 LOC) → Split into:
  - `internal/resources/job.go` (~200 LOC)
  - `internal/resources/service.go` (~100 LOC)
  - `internal/resources/pod.go` (~150 LOC)
- `LoadGenHelpers.java` (398 LOC) → `internal/resources/helpers.go` (~150 LOC)

**Effort:** ~500 LOC Go (reduction due to less verbosity)

### 5.4 Phase 4: Reconciler

**Source Files:**
- `LocustTestReconciler.java` (128 LOC) → `internal/controller/locusttest_controller.go` (~150 LOC)
- `ResourceCreationManager.java` (60 LOC) → Merged into controller
- `ResourceDeletionManager.java` (65 LOC) → Merged into controller

**Effort:** ~200 LOC

### 5.5 Phase 5: Testing

**Source Files:**
- All test files → Corresponding `_test.go` files

**Effort:** ~800 LOC (test code typically similar size)

---

## 6. File Inventory

### 6.1 Source Files Summary

| Category | Files | Java LOC | Est. Go LOC |
|----------|-------|----------|-------------|
| **Entry Point** | 2 | 47 | 30 |
| **CRD Types** | 5 | 140 | 120 |
| **Configuration** | 1 | 104 | 60 |
| **Reconciler** | 1 | 128 | 150 |
| **Resource Managers** | 2 | 125 | 0 (merged) |
| **Resource Helpers** | 2 | 986 | 500 |
| **DTOs** | 4 | 120 | 80 |
| **Constants** | 1 | 89 | 60 |
| **Total Main** | 18 | ~1,739 | ~1,000 |

### 6.2 Test Files Summary

| Category | Files | Java LOC | Est. Go LOC |
|----------|-------|----------|-------------|
| **Unit Tests** | 6 | ~600 | ~500 |
| **Integration Tests** | 3 | ~772 | ~600 |
| **Fixtures** | 1 | ~150 | ~100 |
| **Total Tests** | 10 | ~1,522 | ~1,200 |

### 6.3 Non-Code Files

| File | Action |
|------|--------|
| `build.gradle` | Replace with `go.mod` |
| `gradle/*.gradle` | Delete (not needed) |
| `settings.gradle` | Delete |
| `gradle.properties` | Delete |
| `application.yml` | Convert to ConfigMap or env vars |
| `Dockerfile` | Replace with multi-stage Go build |
| `charts/*/values.yaml` | Update (remove JVM configs) |
| `charts/*/Chart.yaml` | Update version |
| `kube/crd/*.yaml` | Auto-generated by kubebuilder |
| `.github/workflows/*.yml` | Update build commands |

---

## Migration Effort Estimate

| Phase | Description | Effort (days) |
|-------|-------------|---------------|
| 1 | Project setup + CRD types | 1-2 |
| 2 | Configuration system | 0.5 |
| 3 | Resource builders (Job, Service, Pod) | 2-3 |
| 4 | Reconciler implementation | 1-2 |
| 5 | Unit tests | 2-3 |
| 6 | Integration tests | 2-3 |
| 7 | Helm chart updates | 0.5 |
| 8 | CI/CD pipeline updates | 0.5 |
| 9 | Documentation | 1 |
| 10 | Testing & bug fixes | 2-3 |
| **Total** | | **13-18 days** |

---

**Document Version:** 1.0  
**Companion Document:** `ASSESSMENT.md`  
**Next Steps:** Review with team, prioritize phases, create migration branch
